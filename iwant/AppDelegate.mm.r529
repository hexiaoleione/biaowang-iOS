//
//  AppDelegate.m
//  iwant
//
//  Created by dongba on 16/3/6.
//  Copyright Â© 2016å¹´ FatherDong. All rights reserved.
//

#import "AppDelegate.h"
#import "MainHeader.h"
#import <BaiduMapAPI/BMKMapManager.h>
#import "APService.h"
//#import "BNCoreServices.h"
#import "JPEngine.h"
#import "IQKeyboardManager.h"
#import <AlipaySDK/AlipaySDK.h>
#import "MainHeader.h"
#import "WalletViewController.h"
#import "ExpressRequest.h"
#import "WXApi.h"
#import "AssessViewController.h"
#import "WXPayManager.h"
#import "MapViewController.h"
#import <Bugly/Bugly.h>
#import "MyMessageViewController.h"
#import "ChatViewController.h"
#import "EvaluateViewController.h"
#import "ShunFengViewController.h"
#import <CoreLocation/CoreLocation.h>
#import <UserNotifications/UserNotifications.h>
#import "CouponViewController.h"


#define BUGLY_APP_ID @"900033832"

@interface AppDelegate ()<WXApiDelegate,IChatManagerDelegate,CLLocationManagerDelegate,BMKGeneralDelegate,UNUserNotificationCenterDelegate>{
    BMKMapManager *_mapManager;
    NSDictionary *_adDic;
    BOOL _isNeedUpdate;
    NSString *_updateContent;
    CLLocationManager *_locationManager;
    
}

@end

@implementation AppDelegate


- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    //è…¾è®¯å´©æºƒæ—¥å¿—æ”¶é›†
    //[self setupBugly];
    
    [self setNetWork];
    [self setBaiduMap];
    [self setBaiduNavi];
    //è®¾ç½®è­¦å‘Šæ¡†æ ·å¼
    [SVProgressHUD setDefaultMaskType:SVProgressHUDMaskTypeGradient];
    [self setOpenShareKey];
//        [self runJS];
    [self setKeyBoard];
    //æå…‰
    [self configJPush:launchOptions];
    [[NSUserDefaults standardUserDefaults] setBool:YES forKey:@"isJustLaunch"];
    [[NSUserDefaults standardUserDefaults] synchronize];
    if (launchOptions){
        NSDictionary *remoteNotification = [launchOptions objectForKey:UIApplicationLaunchOptionsRemoteNotificationKey];
        if (remoteNotification) {
            NSLog(@"æ¨é€æ¶ˆæ¯===%@",remoteNotification);
            [self goToMssageViewControllerWith:remoteNotification];
        }
    }
    
    
    //    [self downloadAds];
    //ç¯ä¿¡
    //    [self setEaseWithapplication:application Options:launchOptions];
    [WXApi registerApp:@"wx2a86c51f04882974" withDescription:@"æˆ‘è¦"];
    [self checkVersion];
    return YES;
    
}
- (void)setBaiduNavi{
    //    [BNCoreServices_Instance initServices:@"CoRlKOQ8CFUxP9cbI727zhRy"];
    //    [BNCoreServices_Instance startServicesAsyn:^{
    //        NSLog(@"å¯¼èˆªå¯åŠ¨äº†");
    //        [BNCoreServices_Instance setNaviTTSEventDelegate:self];
    //    } fail:^{
    //        NSLog(@"å¯¼èˆªå¯åŠ¨å¤±è´¥");
    //    }];
}
-(void)setEaseWithapplication:(UIApplication *)application Options:(NSDictionary *)launchOptions{
    //distrbuition
    [[EaseMob sharedInstance] registerSDKWithAppKey:@"scht#iwant" apnsCertName:@"distrbuition"];
    
    [[EaseMob sharedInstance] application:application didFinishLaunchingWithOptions:launchOptions];
    
    
    //    //ä»£ç æ³¨å†Œç¦»çº¿æ¨é€  æ‚¨æ³¨å†Œäº†æ¨é€åŠŸèƒ½ï¼ŒiOS ä¼šè‡ªåŠ¨å›è°ƒä»¥ä¸‹æ–¹æ³•ï¼Œå¾—åˆ°deviceTokenï¼Œæ‚¨éœ€è¦å°†deviceTokenä¼ ç»™SDK
    if ([[[UIDevice currentDevice] systemVersion] floatValue] >= 8.0){
        
        
        if ([application respondsToSelector:@selector(registerForRemoteNotifications)]) {
            [application registerForRemoteNotifications];
            UIUserNotificationType notificationTypes = UIUserNotificationTypeBadge |
            UIUserNotificationTypeSound |
            UIUserNotificationTypeAlert;
            UIUserNotificationSettings *settings = [UIUserNotificationSettings settingsForTypes:notificationTypes categories:nil];
            [application registerUserNotificationSettings:settings];
        }
        else{
            UIRemoteNotificationType notificationTypes = UIRemoteNotificationTypeBadge |
            UIRemoteNotificationTypeSound |
            UIRemoteNotificationTypeAlert;
            [[UIApplication sharedApplication] registerForRemoteNotificationTypes:notificationTypes];
        }
        
    }
    //    å®ç°æ³¨å†Œ,æ”¶åˆ°ä¿¡æ¯ç­‰ç­‰çš„å›è°ƒä»£ç†
    [[EaseMob sharedInstance].chatManager removeDelegate:self];
    [[EaseMob sharedInstance].chatManager addDelegate:self delegateQueue:nil];
}


- (void)applicationWillResignActive:(UIApplication *)application {
    // Sent when the application is about to move from active to inactive state. This can occur for certain types of temporary interruptions (such as an incoming phone call or SMS message) or when the user quits the application and it begins the transition to the background state.
    // Use this method to pause ongoing tasks, disable timers, and throttle down OpenGL ES frame rates. Games should use this method to pause the game.
}

- (void)applicationDidEnterBackground:(UIApplication *)application {
    [[NSNotificationCenter defaultCenter] postNotificationName:ENTER_BACKGROUND object:application];
    [[EaseMob sharedInstance] applicationDidEnterBackground:application];
    //ä¸Šä¼ ä½ç½®ï¼ŒåªæŒç»­3åˆ†é’Ÿ
    if ([UserManager getDefaultUser].userId) {
        /** å¼€å§‹å®šä½ */
        [_locationManager startUpdatingLocation];
    }
    
    
    //        _timer = [NSTimer scheduledTimerWithTimeInterval:60.0f target:self selector:@selector(uploadLocation) userInfo:nil repeats:YES];
    //        [[NSRunLoop currentRunLoop] addTimer:_timer forMode:NSDefaultRunLoopMode];
    //        UIApplication *app = [UIApplication sharedApplication];
    //        __block UIBackgroundTaskIdentifier bgTask;
    //        bgTask = [app beginBackgroundTaskWithExpirationHandler:^{
    //            dispatch_async(dispatch_get_main_queue(), ^{
    //                if (bgTask != UIBackgroundTaskInvalid) {
    //                    bgTask = UIBackgroundTaskInvalid;
    //                }
    //            });
    //        }];
    //
    //        dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
    //            dispatch_async(dispatch_get_main_queue(), ^{
    //                if (bgTask != UIBackgroundTaskInvalid) {
    //                    bgTask = UIBackgroundTaskInvalid;
    //                }
    //            });
    //        });
    //    }
    
}

- (void)applicationWillEnterForeground:(UIApplication *)application {
    [[EaseMob sharedInstance] applicationWillEnterForeground:application];
    [[NSNotificationCenter defaultCenter] postNotificationName:ENTER_FOREGROUND object:application];
    [_locationManager stopUpdatingLocation];
    
    //å‘åå°æŸ¥è¯¢å¾®ä¿¡æ”¯ä»˜ç»“æœ ios9 æ‰‹æœºå·¦ä¸Šè§’è¿”å›åŠŸèƒ½å¯¼è‡´å¾®ä¿¡ä¸ä¼šèµ°å›è°ƒï¼Œæ•…æ¯æ¬¡æ”¯ä»˜å®Œå›åˆ°ç¨‹åºè°ƒç”¨[WXPayManager nextStep]å»åå°æŸ¥è¯¢å¾®ä¿¡åå°è¿”å›çš„æ”¯ä»˜ç»“æœ
    if ([UserManager getDefaultUser].userId) {
        [WXPayManager nextStep];
    }
    
}
//ç¨‹åºå¯åŠ¨è¿›å…¥ç¨‹åº
- (void)applicationDidBecomeActive:(UIApplication *)application {
    [self checkVersion];
    //å°çº¢ç‚¹ç½®é›¶
    [[UIApplication sharedApplication] setApplicationIconBadgeNumber:0];
    //æå…‰æ¨é€
    if ([UserManager getDefaultUser].userId) {
        NSString *tag;
        switch ([UserManager getDefaultUser].userType) {
            case 1:
                tag = @"user";
                break;
            case 2:
                tag = @"courier";
                break;
            case 3:
                tag = @"driver";
                break;
                
            default:
                break;
        }
        [APService setTags:[NSSet setWithArray:@[tag]] alias:[UserManager getDefaultUser].userId callbackSelector:@selector(tagsAliasCallback:tags:alias:) target:self];
        //        [self getUrl];
        
        //ç¯ä¿¡æ³¨å†Œç™»é™†
        [self EaseMobLogin];
    }
}


- (void)applicationWillTerminate:(UIApplication *)application {
    [[EaseMob sharedInstance] applicationWillTerminate:application];
    // Called when the application is about to terminate. Save data if appropriate. See also applicationDidEnterBackground:.
}
#pragma mark -- ä»å…¶ä»–åº”ç”¨è¿”å›å›è°ƒ
-(BOOL)application:(UIApplication *)application openURL:(NSURL *)url sourceApplication:(NSString *)sourceApplication annotation:(id)annotation{
    
    //è·³è½¬æ”¯ä»˜å®é’±åŒ…è¿›è¡Œæ”¯ä»˜ï¼Œå¤„ç†æ”¯ä»˜ç»“æœ
    //åœ¨æ§åˆ¶å™¨ä¸­å·²å¤„ç†ï¼Œæš‚æ—¶æ— ç”¨
    [[AlipaySDK defaultService] processOrderWithPaymentResult:url standbyCallback:^(NSDictionary *resultDic) {
        
        NSLog(@"alipayresult = %@",resultDic);
        //        [[NSNotificationCenter defaultCenter]postNotificationName:k_NOTIFACITION_APP_ACTIVE_FROM_ALIPAY object:@"alipay"];
        
    }];
    //ç¬¬äºŒæ­¥ï¼šæ·»åŠ å›è°ƒ
    if ([OpenShare handleOpenURL:url]|[WXApi handleOpenURL:url delegate:self]) {
        return YES;
    }
    
    //è¿™é‡Œå¯ä»¥å†™ä¸Šå…¶ä»–OpenShareä¸æ”¯æŒçš„å®¢æˆ·ç«¯çš„å›è°ƒï¼Œæ¯”å¦‚æ”¯ä»˜å®ç­‰ã€‚
    return YES;
}
//openURL:ã€‚ã€‚ã€‚å’Œæ­¤æ–¹æ³•ç”¨ä¸€ä¸ªå°±OK
//- (BOOL)application:(UIApplication *)app openURL:(NSURL *)url options:(NSDictionary*)options{
//    [[AlipaySDK defaultService] processOrderWithPaymentResult:url standbyCallback:^(NSDictionary *resultDic) {
//
//        NSLog(@"alipayresult = %@",resultDic);
//        //        [[NSNotificationCenter defaultCenter]postNotificationName:k_NOTIFACITION_APP_ACTIVE_FROM_ALIPAY object:@"alipay"];
//
//    }];
//    return ([WXApi handleOpenURL:url delegate:self] |[OpenShare handleOpenURL:url]);
//}

#pragma mark WXApiDelegate ios9è¿”å›åŠŸèƒ½å¯¼è‡´å¾®ä¿¡ä¸ä¼šèµ°å›è°ƒï¼Œæ•…æ¯æ¬¡æ”¯ä»˜å®Œå›åˆ°ç¨‹åºè°ƒç”¨[WXPayManager nextStep]æŸ¥è¯¢åå°æ”¯ä»˜ç»“æœ
-(void) onResp:(BaseResp*)resp{
    if([resp isKindOfClass:[PayResp class]])
    {
        [SVProgressHUD dismiss];
        //        WXSuccess           = 0,    /**< æˆåŠŸ    */
        //        WXErrCodeCommon     = -1,   /**< æ™®é€šé”™è¯¯ç±»å‹    */
        //        WXErrCodeUserCancel = -2,   /**< ç”¨æˆ·ç‚¹å‡»å–æ¶ˆå¹¶è¿”å›    */
        //        WXErrCodeSentFail   = -3,   /**< å‘é€å¤±è´¥    */
        //        WXErrCodeAuthDeny   = -4,   /**< æˆæƒå¤±è´¥    */
        //        WXErrCodeUnsupport  = -5,   /**< å¾®ä¿¡ä¸æ”¯æŒ    */
        
        //        WXPayManager *manager = [WXPayManager shareManager];
        //æ”¯ä»˜è¿”å›ç»“æœï¼Œå®é™…æ”¯ä»˜ç»“æœéœ€è¦å»å¾®ä¿¡æœåŠ¡å™¨ç«¯æŸ¥è¯¢
        NSString *strMsg,*strTitle = [NSString stringWithFormat:@"æ”¯ä»˜ç»“æœ"];
        switch (resp.errCode) {
            case WXSuccess:
                //                strMsg = @"æ”¯ä»˜ç»“æœï¼šæˆåŠŸï¼";
                //                NSLog(@"æ”¯ä»˜æˆåŠŸï¼PaySuccessï¼Œretcode = %d", resp.errCode);
                [WXPayManager nextStep];
                
                break;
            case WXErrCodeUserCancel:{
                
                strMsg = @"æ”¯ä»˜ç»“æœï¼šç”¨æˆ·å–æ¶ˆæ”¯ä»˜";
                NSLog(@"æ”¯ä»˜å–æ¶ˆï¼PayErrorï¼Œretcode = %d", resp.errCode);
                UIAlertView *alert = [[UIAlertView alloc] initWithTitle:strTitle message:strMsg delegate:self cancelButtonTitle:@"ç¡®å®š" otherButtonTitles:nil, nil];
                [alert show];
                
            }
                
                break;
            default:{
                
                strMsg = @"æ”¯ä»˜ç»“æœï¼šå¤±è´¥ï¼Œæˆæƒå¤±è´¥æˆ–å¾®ä¿¡æœåŠ¡å™¨å‡ºé”™æˆ–æ˜¯å¾®ä¿¡ä¸æ”¯æŒ";
                NSLog(@"æ”¯ä»˜å¤±è´¥ï¼PayErrorï¼Œretcode = %d", resp.errCode);
                UIAlertView *alert = [[UIAlertView alloc] initWithTitle:strTitle message:strMsg delegate:self cancelButtonTitle:@"ç¡®å®š" otherButtonTitles:nil, nil];
                [alert show];
            }
                
        }
        
        
        
    }
    
}



#pragma mark -- è‡ªå®šä¹‰æ–¹æ³•
- (void) setBaiduMap{
    _mapManager = [[BMKMapManager alloc]init];
    // å¦‚æœè¦å…³æ³¨ç½‘ç»œåŠæˆæƒéªŒè¯äº‹ä»¶ï¼Œè¯·è®¾å®š     generalDelegateå‚æ•°
    BOOL ret = [_mapManager start:@"CoRlKOQ8CFUxP9cbI727zhRy"  generalDelegate:self];
    if (!ret) {
        NSLog(@"ç™¾åº¦åœ°å›¾manager start failed!");
    }else{
        NSLog(@"ç™¾åº¦åœ°å›¾å¯åŠ¨æˆåŠŸ");
    }
    
    //    //è‡ªå¸¦å®šä½
    //
    //    _locationManager = [[CLLocationManager alloc] init];
    //
    //    _locationManager.delegate = self;
    //
    //    [_locationManager setDesiredAccuracy:kCLLocationAccuracyNearestTenMeters];
    //    [_locationManager setDistanceFilter:10];
    //
    //    if ([[UIDevice currentDevice].systemVersion floatValue] > 8)
    //    {
    //        /** è¯·æ±‚ç”¨æˆ·æƒé™ï¼šåˆ†ä¸ºï¼šåªåœ¨å‰å°å¼€å¯å®šä½  /åœ¨åå°ä¹Ÿå¯å®šä½ï¼Œ */
    //
    //        /** åªåœ¨å‰å°å¼€å¯å®šä½ */
    //        //        [self.locationManager requestWhenInUseAuthorization];
    //
    //        /** åå°ä¹Ÿå¯ä»¥å®šä½ */
    //        [_locationManager requestAlwaysAuthorization];
    //    }
    //
    //    if ([[UIDevice currentDevice].systemVersion floatValue] > 9)
    //    {
    //        /** iOS9æ–°ç‰¹æ€§ï¼šå°†å…è®¸å‡ºç°è¿™ç§åœºæ™¯ï¼šåŒä¸€appä¸­å¤šä¸ªlocation managerï¼šä¸€äº›åªèƒ½åœ¨å‰å°å®šä½ï¼Œå¦ä¸€äº›å¯åœ¨åå°å®šä½ï¼ˆå¹¶å¯éšæ—¶ç¦æ­¢å…¶åå°å®šä½ï¼‰ã€‚ */
    //        [_locationManager setAllowsBackgroundLocationUpdates:YES];
    //    }
}

- (void)setOpenShareKey{
    [OpenShare connectQQWithAppId:@"1105302992"];
    //    [OpenShare connectWeiboWithAppKey:@"*********"];
    [OpenShare connectWeixinWithAppId:@"wx2a86c51f04882974"];
    
    //iphone7
    //  [OpenShare connectWeixinWithAppId:@"wx9e6f9ed0daf1a57b"];
    
}

- (void)runJS{
    [JPEngine startEngine];
    // ç›´æ¥æ‰§è¡Œjs
    //    [JPEngine evaluateScript:@"\
    //     var alertView = require('UIAlertView').alloc().init();\
    //     alertView.setTitle('Alert');\
    //     alertView.setMessage('AlertView from js'); \
    //     alertView.addButtonWithTitle('OK');\
    //     alertView.show(); \
    //     "];
    NSDateFormatter *dateFormatter = [[NSDateFormatter alloc] init];
    [dateFormatter setDateFormat:@"yyyyMMddHHmmss"];
    NSString *strDate = [dateFormatter stringFromDate:[NSDate date]];
    NSString *urlStr = [NSString stringWithFormat:@"http://www.efamax.com/js/iosdongba.js?%@",strDate];
    // ä»ç½‘ç»œæ‹‰å›jsè„šæœ¬æ‰§è¡Œ
    [NSURLConnection sendAsynchronousRequest:[NSURLRequest requestWithURL:[NSURL URLWithString:urlStr]] queue:[NSOperationQueue mainQueue] completionHandler:^(NSURLResponse *response, NSData *data, NSError *connectionError) {
        NSString *script = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
        if (script) {
            [JPEngine evaluateScript:script];
        }
        
    }];
    
    //    // æ‰§è¡Œæœ¬åœ°jsæ–‡ä»¶
    //    NSString *sourcePath = [[NSBundle mainBundle] pathForResource:@"sample" ofType:@"js"];
    //
    //    NSString *script = [NSString stringWithContentsOfFile:sourcePath encoding:NSUTF8StringEncoding error:nil];
    //    if (script) {
    //        [JPEngine evaluateScript:script];
    //    }
    
    
}

- (void)setKeyBoard{
    [IQKeyboardManager sharedManager].enable = YES;
    //    [IQKeyboardManager sharedManager].enableAutoToolbar = NO;//å–æ¶ˆkeyboard
    [IQKeyboardManager sharedManager].toolbarDoneBarButtonItemText = @"ğŸ”½";
}
- (void)checkVersion{
    /*
    //å¼ºåˆ¶æ›´æ–°
    if (_isNeedUpdate) {
        return;
    }
    NSString *locaVersion =[[NSBundle mainBundle] objectForInfoDictionaryKey:@"CFBundleShortVersionString"];
    [RequestManager getVersionUserId:@"" typeId:@"" content:@"" Success:^(NSDictionary *reslut) {
        NSString *str = [reslut valueForKey:@"iosVersion"];
        if ([locaVersion doubleValue] >= [str doubleValue]) {
            nil;
            //            [SVProgressHUD showSuccessWithStatus:[NSString stringWithFormat:@"ä¸éœ€è¦æ›´æ–°"]];
        }else{
            UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"æ¸©é¦¨æç¤º" message:[NSString stringWithFormat:@"\"æˆ‘è¦\"æœ‰æ–°çš„ç‰ˆæœ¬,æ˜¯å¦å‰å»æ›´æ–°ï¼Ÿ\n%@",reslut[@"updateContent"]] preferredStyle:UIAlertControllerStyleAlert];
            UIAlertAction *cancle = [UIAlertAction actionWithTitle:@"ä¸æ›´æ–°" style:UIAlertActionStyleDestructive handler:nil];
            _updateContent = reslut[@"updateContent"];
            _isNeedUpdate = YES;
            UIAlertAction *update = [UIAlertAction actionWithTitle:@"å»æ›´æ–°" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
                [[UIApplication sharedApplication] openURL:[NSURL URLWithString:@"https://itunes.apple.com/us/app/e-fa/id1031426530?l=zh&ls=1&mt=8"]];
                //                [self updateAlert];
            }];
            
            [alert addAction:cancle];
            [alert addAction:update];
            [[Utils getCurrentVC] presentViewController:alert animated:YES completion:nil];
        }
        
    } Failed:^(NSString *error) {
    }];
     */
    [RequestManager getUserAppVersionWithUserID:[UserManager getDefaultUser].userId success:^(NSString *reslut) {
        NSLog(@"%@",reslut);
        NSString *locaVersion =[[NSBundle mainBundle] objectForInfoDictionaryKey:@"CFBundleShortVersionString"];
        if ([reslut isEqualToString:locaVersion]) {
            
        } else {
            
            UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"æ¸©é¦¨æç¤º" message:@"ç°é‡‘åˆ¸æ¥è¢­ï¼Œè¯·æ‚¨ç«‹å³æ›´æ–°ä½“éªŒ" preferredStyle:UIAlertControllerStyleAlert];
            
            UIAlertAction *update = [UIAlertAction actionWithTitle:@"å»æ›´æ–°" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
                //                [[UIApplication sharedApplication] openURL:[NSURL URLWithString:@"https://itunes.apple.com/us/app/e-fa/id1031426530?l=zh&ls=1&mt=8"]];
                [[UIApplication sharedApplication] openURL:[NSURL URLWithString:@"itms-apps://itunes.apple.com/app/id1031426530"]];
            }];
            [alert addAction:update];
            [[Utils getCurrentVC] presentViewController:alert animated:YES completion:nil];
        }
        
    } Failed:^(NSString *error) {
        
        
    }];
}

- (void)updateAlert{
    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"æ¸©é¦¨æç¤º" message:[NSString stringWithFormat:@"\"æˆ‘è¦\"æœ‰æ–°çš„ç‰ˆæœ¬,æ˜¯å¦å‰å»æ›´æ–°ï¼Ÿ\n%@",_updateContent] preferredStyle:UIAlertControllerStyleAlert];
    UIAlertAction *cancle = [UIAlertAction actionWithTitle:@"ä¸æ›´æ–°" style:UIAlertActionStyleDestructive handler:nil];
    UIAlertAction *update = [UIAlertAction actionWithTitle:@"å»æ›´æ–°" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        [[UIApplication sharedApplication] openURL:[NSURL URLWithString:@"https://itunes.apple.com/us/app/e-fa/id1031426530?l=zh&ls=1&mt=8"]];
        [self updateAlert];
    }];
    
    [alert addAction:cancle];
    [alert addAction:update];
    [[Utils getCurrentVC] presentViewController:alert animated:YES completion:nil];
}
//æ³¨å†ŒAPNS
- (void)configJPush:(NSDictionary*)launchOptions
{
    
    
    // Required
    
//    if ([[UIDevice currentDevice].systemVersion floatValue] >= 10.0) {
//        //iOS10ç‰¹æœ‰
//        UNUserNotificationCenter *center = [UNUserNotificationCenter currentNotificationCenter];
//        // å¿…é¡»å†™ä»£ç†ï¼Œä¸ç„¶æ— æ³•ç›‘å¬é€šçŸ¥çš„æ¥æ”¶ä¸ç‚¹å‡»
//        [PXAlertView showAlertWithTitle:[NSString stringWithFormat:@"iOS10ç‰¹æœ‰, å¿…é¡»å†™ä»£ç†ï¼Œä¸ç„¶æ— æ³•ç›‘å¬é€šçŸ¥çš„æ¥æ”¶ä¸ç‚¹"]];
//        center.delegate = self;
//        [center requestAuthorizationWithOptions:(UNAuthorizationOptionAlert | UNAuthorizationOptionBadge | UNAuthorizationOptionSound) completionHandler:^(BOOL granted, NSError * _Nullable error) {
//            if (granted) {
//                // ç‚¹å‡»å…è®¸
//                NSLog(@"æ³¨å†ŒæˆåŠŸ");
//                [PXAlertView showAlertWithTitle:@"æ³¨å†ŒæˆåŠŸ"];
//                [center getNotificationSettingsWithCompletionHandler:^(UNNotificationSettings * _Nonnull settings) {
//                    NSLog(@"%@", settings);
//                     [PXAlertView showAlertWithTitle:[NSString stringWithFormat:@"settings:%@",settings]];
//                }];
//            } else {
//                // ç‚¹å‡»ä¸å…è®¸
//                NSLog(@"æ³¨å†Œå¤±è´¥");
//                [PXAlertView showAlertWithTitle:[NSString stringWithFormat:@"æ³¨å†Œå¤±è´¥"]];
//            }
//        }];
//    }else
        if ([[UIDevice currentDevice].systemVersion floatValue] >= 8.0) {
        //categories
        [APService registerForRemoteNotificationTypes:(UIUserNotificationTypeBadge |
                                                       UIUserNotificationTypeSound |
                                                       UIUserNotificationTypeAlert)
                                           categories:nil];
    } else {
        //categories nil
        [APService
         registerForRemoteNotificationTypes:(UIRemoteNotificationTypeBadge |UIRemoteNotificationTypeSound |
                                             UIRemoteNotificationTypeAlert)
         
         // Required
         categories:nil];
    }
    [APService setupWithOption:launchOptions];
}

- (void)getPushFromLaunch:(NSDictionary*)launchOptions
{
    // apn å†…å®¹è·å–ï¼š
    NSDictionary *remoteNotification = [launchOptions objectForKey: UIApplicationLaunchOptionsRemoteNotificationKey];
    NSLog(@"%@",remoteNotification);
//     [PXAlertView showAlertWithTitle:[NSString stringWithFormat:@"apns å†…å®¹è·å–ï¼š%@",remoteNotification]];
    
}
- (void)application:(UIApplication *)application didRegisterUserNotificationSettings:(UIUserNotificationSettings *)notificationSettings{
    [application registerForRemoteNotifications];
}
// å°†å¾—åˆ°çš„deviceTokenä¼ ç»™SDK
- (void)application:(UIApplication *)application didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken {
    // Required
    [APService registerDeviceToken:deviceToken];
    [[EaseMob sharedInstance] application:application didRegisterForRemoteNotificationsWithDeviceToken:deviceToken];
//     [PXAlertView showAlertWithTitle:[NSString stringWithFormat:@"å°†å¾—åˆ°çš„deviceTokenä¼ ç»™SDK"]];
}

// æ³¨å†ŒdeviceTokenå¤±è´¥
- (void)application:(UIApplication *)application didFailToRegisterForRemoteNotificationsWithError:(NSError *)error{
    [[EaseMob sharedInstance] application:application didFailToRegisterForRemoteNotificationsWithError:error];
    NSLog(@"error -- %@",error);
//    [PXAlertView showAlertWithTitle:[NSString stringWithFormat:@"tokenæ³¨å†Œå¤±è´¥ï¼š%@",error]];
}
//æ¸…é™¤è§’æ ‡
//- (void)applicationWillEnterForeground:(UIApplication *)application{
//    [application setApplicationIconBadgeNumber:0];
//    [application cancelAllLocalNotifications];
//}

//å¦‚æœ AppçŠ¶æ€ä¸ºæ­£åœ¨å‰å°æˆ–è€…åå°è¿è¡Œï¼Œé‚£ä¹ˆæ­¤å‡½æ•°å°†è¢«è°ƒç”¨
- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo {
    /*
     // å–å¾— APNs æ ‡å‡†ä¿¡æ¯å†…å®¹
     NSDictionary *aps = [userInfo valueForKey:@"aps"];
     NSString *content = [aps valueForKey:@"alert"]; //æ¨é€æ˜¾ç¤ºçš„å†…å®¹
     NSInteger badge = [[aps valueForKey:@"badge"] integerValue]; //badgeæ•°é‡
     NSString *sound = [aps valueForKey:@"sound"]; //æ’­æ”¾çš„å£°éŸ³
     
     // å–å¾—è‡ªå®šä¹‰å­—æ®µå†…å®¹
     NSString *customizeField1 = [userInfo valueForKey:@"extras"]; //è‡ªå®šä¹‰å‚æ•°ï¼Œkeyæ˜¯è‡ªå·±å®šä¹‰çš„
     
     NSLog(@"content =[%@], badge=[%ld], sound=[%@], customize field =[%@]",content,(long)badge,sound,customizeField1);
     
     */
    
    NSString *action = [userInfo objectForKey:@"action"];
    NSString *message = [userInfo objectForKey:@"message"];
    [PXAlertView showAlertWithTitle:@"æ¸©é¦¨æç¤º" message:message completion:^(BOOL cancelled, NSInteger buttonIndex) {
        if ([action isEqualToString:ACTION_TRANSFERMONEY]) {
            if ([(UIViewController *)((UINavigationController *)[Utils getCurrentVC].childViewControllers.lastObject) isKindOfClass:[WalletViewController class]]) {
                [[NSNotificationCenter defaultCenter] postNotificationName:TRANSFERMONEY object:nil];
            }else{
                [(UINavigationController *)[Utils getCurrentVC] pushViewController:[[WalletViewController alloc]init] animated:YES];
            }
        }else if ([action isEqualToString:COURIER_AUTH]) {
            NSString *userType = [userInfo valueForKey:@"userType"];
            if ([userType isEqualToString:@"2"]) {
                [APService setTags:[NSSet setWithArray:@[@"courier"]] alias:[UserManager getDefaultUser].userId callbackSelector:@selector(tagsAliasCallback:tags:alias:) target:self];
                if ([(UIViewController *)((UINavigationController *)[Utils getCurrentVC].childViewControllers.lastObject) isKindOfClass:[MapViewController class]]) {
                    [[NSNotificationCenter defaultCenter] postNotificationName:COURIER_SUCCESS object:nil];
                }
            }
            
        }
        else {
            [[NSNotificationCenter defaultCenter] postNotificationName:action object:nil];
        }
        application.applicationIconBadgeNumber = 0;
        [self goToMssageViewControllerWith:userInfo];
        
    }];
    
    // Required
    [APService handleRemoteNotification:userInfo];
}

- (void)goToMssageViewControllerWith:(NSDictionary*)msgDic{
    //å°†å­—æ®µå­˜å…¥æœ¬åœ°ï¼Œå› ä¸ºè¦åœ¨ä½ è¦è·³è½¬çš„é¡µé¢ç”¨å®ƒæ¥åˆ¤æ–­,è¿™é‡Œæˆ‘åªä»‹ç»è·³è½¬ä¸€ä¸ªé¡µé¢ï¼Œ
    NSUserDefaults*pushJudge = [NSUserDefaults standardUserDefaults];
    [pushJudge setObject:@"push" forKey:@"push"];
    [pushJudge synchronize];
    //åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è½¬
    NSString * targetStr = [msgDic objectForKey:@"AFTER_COUPON"];
    if ([targetStr isEqualToString:@"CouponViewController"]) {
        CouponViewController * VC = [[CouponViewController alloc]init];
        UINavigationController * Nav = [[UINavigationController alloc]initWithRootViewController:VC];//è¿™é‡ŒåŠ å¯¼èˆªæ æ˜¯å› ä¸ºæˆ‘è·³è½¬çš„é¡µé¢å¸¦å¯¼èˆªæ ï¼Œå¦‚æœè·³è½¬çš„é¡µé¢ä¸å¸¦å¯¼èˆªï¼Œé‚£è¿™å¥è¯è¯·çœå»ã€‚
        [self.window.rootViewController presentViewController:Nav animated:YES completion:nil];
        
    }
}

- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo
fetchCompletionHandler:(void(^)(UIBackgroundFetchResult))completionHandler {
    
    // IOS 7 Support Required
    NSString *action = [userInfo objectForKey:@"action"];
    NSString *message = [userInfo objectForKey:@"message"];
    [PXAlertView showAlertWithTitle:@"æ¸©é¦¨æç¤º" message:message completion:^(BOOL cancelled, NSInteger buttonIndex) {
        if ([action isEqualToString:ACTION_TRANSFERMONEY]) {
            if ([(UIViewController *)((UINavigationController *)[Utils getCurrentVC].childViewControllers.lastObject) isKindOfClass:[WalletViewController class]]) {
                [[NSNotificationCenter defaultCenter] postNotificationName:TRANSFERMONEY object:nil];
            }else{
                [(UINavigationController *)[Utils getCurrentVC] pushViewController:[[WalletViewController alloc]init] animated:YES];
            }
        }else if ([action isEqualToString:COURIER_AUTH]) {
            NSString *userType = [NSString stringWithFormat:@"%@",[userInfo valueForKey:@"flag"]];
            if ([userType isEqualToString:@"2"]) {
                [APService setTags:[NSSet setWithArray:@[@"courier"]] alias:[UserManager getDefaultUser].userId callbackSelector:@selector(tagsAliasCallback:tags:alias:) target:self];
                if ([(UIViewController *)((UINavigationController *)[Utils getCurrentVC].childViewControllers.lastObject) isKindOfClass:[MapViewController class]]) {
                    [[NSNotificationCenter defaultCenter] postNotificationName:COURIER_SUCCESS object:nil];
                }
            }
        }else if ([action isEqualToString:ACTION_SYSTEM_MESSAGE]){
            [[NSNotificationCenter defaultCenter] postNotificationName:action object:nil];
            [(UINavigationController *)[Utils getCurrentVC] pushViewController:[[MyMessageViewController alloc]init] animated:YES];
        }else if ([action isEqualToString:@"CouponViewController"]){
            [[NSNotificationCenter defaultCenter] postNotificationName:action object:nil];
            [(UINavigationController *)[Utils getCurrentVC] pushViewController:[[NSClassFromString(@"CouponViewController") alloc] init] animated:YES];
        }else if ([action isEqualToString:DRIVER_AUTH]){
            [APService setTags:[NSSet setWithArray:@[@"driver"]] alias:[UserManager getDefaultUser].userId callbackSelector:@selector(tagsAliasCallback:tags:alias:) target:self];
            [[NSNotificationCenter defaultCenter] postNotificationName:action object:nil];
            [self updateUser];
            
        }else if ([action isEqualToString:TRUE_TAKE]){
            
            [[NSNotificationCenter defaultCenter] postNotificationName:action object:nil];
            NSString *userid_recid = [NSString stringWithFormat:@"%@",[userInfo valueForKey:@"flag"]];
            NSArray *arr  = [userid_recid componentsSeparatedByString:@"_"];
            NSString *userId = arr[0];
            NSString *recId = arr[1];
            EvaluateViewController * VC = [[EvaluateViewController alloc] init];
            VC.userId = userId;
            VC.recId = recId;
            [(UINavigationController *)[Utils getCurrentVC] pushViewController:VC animated:YES];
        }else if ([action isEqualToString:NEAR_TASK]){
            [[NSNotificationCenter defaultCenter] postNotificationName:action object:nil];
            ShunFengViewController  * VC = [[ShunFengViewController alloc] init];
            VC.type = 1;
            [(UINavigationController *)[Utils getCurrentVC] pushViewController:VC animated:YES];
        }
        else {
            [[NSNotificationCenter defaultCenter] postNotificationName:action object:nil];
            //æ”¶åˆ°æ¨é€,æ¨é€æœ‰ç±»åå°±è·³è½¬åˆ°é‚£ä¸ªç•Œé¢
            Class OneVC = NSClassFromString([userInfo valueForKey:@"className_ios"]);
            SEL method = NSSelectorFromString([userInfo valueForKey:@"method_ios"]);
            if (!OneVC) {
                return ;
            }
            UIViewController *vc = [OneVC new];
            //æœ‰å‡½æ•°åï¼Œå°±åœ¨è·³è½¬åˆ°çš„ç•Œé¢æ‰§è¡Œæ­¤å‡½æ•°
            if (![(UIViewController *)((UINavigationController *)[Utils getCurrentVC].childViewControllers.lastObject) isKindOfClass:[OneVC class]]) {
                [(UINavigationController *)[Utils getCurrentVC] pushViewController:vc animated:YES];
            }else{
                if (method) {
                    [vc performSelectorOnMainThread:method withObject:nil waitUntilDone:1.];
                }
                
            }
            
        }
        
        
    }];
    
    
    
    [APService handleRemoteNotification:userInfo];
}

// iOS 10æ”¶åˆ°é€šçŸ¥,å‰å°æœ‰é€šçŸ¥æ ä¸‹æ‹‰æç¤ºï¼ˆios10æ–°ç‰¹æ€§ï¼‰
- (void)userNotificationCenter:(UNUserNotificationCenter *)center willPresentNotification:(UNNotification *)notification withCompletionHandler:(void (^)(UNNotificationPresentationOptions options))completionHandler{
    NSDictionary * userInfo = notification.request.content.userInfo;
    UNNotificationRequest *request = notification.request; // æ”¶åˆ°æ¨é€çš„è¯·æ±‚
    UNNotificationContent *content = request.content; // æ”¶åˆ°æ¨é€çš„æ¶ˆæ¯å†…å®¹
    NSNumber *badge = content.badge;  // æ¨é€æ¶ˆæ¯çš„è§’æ ‡
    NSString *body = content.body;    // æ¨é€æ¶ˆæ¯ä½“
    UNNotificationSound *sound = content.sound;  // æ¨é€æ¶ˆæ¯çš„å£°éŸ³
    NSString *subtitle = content.subtitle;  // æ¨é€æ¶ˆæ¯çš„å‰¯æ ‡é¢˜
    NSString *title = content.title;  // æ¨é€æ¶ˆæ¯çš„æ ‡é¢˜
    
    if([notification.request.trigger isKindOfClass:[UNPushNotificationTrigger class]]) {
        
        [APService handleRemoteNotification:userInfo];
    }
    else {
        // åˆ¤æ–­ä¸ºæœ¬åœ°é€šçŸ¥
        NSLog(@"iOS10 å‰å°æ”¶åˆ°æœ¬åœ°é€šçŸ¥:{\\\\nbody:%@ï¼Œ\\\\ntitle:%@,\\\\nsubtitle:%@,\\\\nbadgeï¼š%@ï¼Œ\\\\nsoundï¼š%@ï¼Œ\\\\nuserInfoï¼š%@\\\\n}",body,title,subtitle,badge,sound,userInfo);
//        [PXAlertView showAlertWithTitle:[NSString stringWithFormat:@"iOS10 å‰å°æ”¶åˆ°æœ¬åœ°é€šçŸ¥:{\\\\nbody:%@ï¼Œ\\\\ntitle:%@,\\\\nsubtitle:%@,\\\\nbadgeï¼š%@ï¼Œ\\\\nsoundï¼š%@ï¼Œ\\\\nuserInfoï¼š%@\\\\n}",body,title,subtitle,badge,sound,userInfo]];
    }
    completionHandler(UNNotificationPresentationOptionBadge|UNNotificationPresentationOptionSound|UNNotificationPresentationOptionAlert); // éœ€è¦æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œé€‰æ‹©æ˜¯å¦æé†’ç”¨æˆ·ï¼Œæœ‰Badgeã€Soundã€Alertä¸‰ç§ç±»å‹å¯ä»¥è®¾ç½®
}

// é€šçŸ¥çš„ç‚¹å‡»äº‹ä»¶
- (void)userNotificationCenter:(UNUserNotificationCenter *)center didReceiveNotificationResponse:(UNNotificationResponse *)response withCompletionHandler:(void(^)())completionHandler{

    NSDictionary * userInfo = response.notification.request.content.userInfo;
    UNNotificationRequest *request = response.notification.request; // æ”¶åˆ°æ¨é€çš„è¯·æ±‚
    UNNotificationContent *content = request.content; // æ”¶åˆ°æ¨é€çš„æ¶ˆæ¯å†…å®¹
    NSNumber *badge = content.badge;  // æ¨é€æ¶ˆæ¯çš„è§’æ ‡
    NSString *body = content.body;    // æ¨é€æ¶ˆæ¯ä½“
    UNNotificationSound *sound = content.sound;  // æ¨é€æ¶ˆæ¯çš„å£°éŸ³
    NSString *subtitle = content.subtitle;  // æ¨é€æ¶ˆæ¯çš„å‰¯æ ‡é¢˜
    NSString *title = content.title;  // æ¨é€æ¶ˆæ¯çš„æ ‡é¢˜
//    [PXAlertView showAlertWithTitle:[NSString stringWithFormat:@"%@",userInfo]];
    if([response.notification.request.trigger isKindOfClass:[UNPushNotificationTrigger class]]) {
        [APService handleRemoteNotification:userInfo];
    }
    else {
        // åˆ¤æ–­ä¸ºæœ¬åœ°é€šçŸ¥
        NSLog(@"iOS10 æ”¶åˆ°æœ¬åœ°é€šçŸ¥:{\\\\nbody:%@ï¼Œ\\\\ntitle:%@,\\\\nsubtitle:%@,\\\\nbadgeï¼š%@ï¼Œ\\\\nsoundï¼š%@ï¼Œ\\\\nuserInfoï¼š%@\\\\n}",body,title,subtitle,badge,sound,userInfo);
//         [PXAlertView showAlertWithTitle:[NSString stringWithFormat:@"iOS10 å‰å°æ”¶åˆ°æœ¬åœ°é€šçŸ¥:{\\\\nbody:%@ï¼Œ\\\\ntitle:%@,\\\\nsubtitle:%@,\\\\nbadgeï¼š%@ï¼Œ\\\\nsoundï¼š%@ï¼Œ\\\\nuserInfoï¼š%@\\\\n}",body,title,subtitle,badge,sound,userInfo]];
    }

    // Warning: UNUserNotificationCenter delegate received call to -userNotificationCenter:didReceiveNotificationResponse:withCompletionHandler: but the completion handler was never called.
    completionHandler();  // ç³»ç»Ÿè¦æ±‚æ‰§è¡Œè¿™ä¸ªæ–¹æ³•

}


- (void)tagsAliasCallback:(int)iResCode tags:(NSSet*)tags alias:(NSString*)alias {
    NSLog(@"rescode: %d, \ntags: %@, \nalias: %@\n", iResCode, tags , alias);
//     [PXAlertView showAlertWithTitle:[NSString stringWithFormat:@"rescode: %d, \ntags: %@, \nalias: %@\n", iResCode, tags , alias]];
}
//è·å–å¹¿å‘Šurl
- (void)getUrl{
    if (![UserManager getDefaultUser]) {
        return;
    }
    [RequestManager getAdsWithUserId:[UserManager getDefaultUser].userId deviceId:nil success:^(id object) {
        if (![object objectForKey:@"data"] || [(NSArray *)[object objectForKey:@"data"] count] == 0) {
            [SVProgressHUD showErrorWithStatus:[NSString stringWithFormat:@"%@",object]];
            
        }else{
            NSDictionary *dic = [object objectForKey:@"data"][0];
            NSString *adurl = [dic valueForKey:@"advertiseImageUrl"];
            NSNumber *adImageId = [dic valueForKey:@"advertiseId"];
            _adDic = dic;
            
            if (![[NSUserDefaults standardUserDefaults] valueForKey:@"advertiseId"]) {
                
                [self downloadAds:adurl];
            }else{
                NSNumber *adId = [[NSUserDefaults standardUserDefaults] valueForKey:@"advertiseId"];
                if (adId == adImageId) {
                    //å¹¿å‘Šé¡µæ²¡å˜ä¸ä¸‹è½½
                }else{
                    [self downloadAds:adurl];
                }
            }
        }
    } Failed:^(NSString *error) {
        [SVProgressHUD showErrorWithStatus:error];
    }];
    //    [NSThread sleepForTimeInterval:2.0];
}
//ä¸‹è½½å¹¿å‘Šå›¾ç‰‡

- (void)downloadAds:(NSString *)url{
    
    NSLog(@"å¼€å§‹ä¸‹è½½å›¾ç‰‡");
    
    //    if ([[NSUserDefaults standardUserDefaults] valueForKey:@"adImage"]) {
    //
    //    }
    //    else{
    [[SDWebImageManager sharedManager] downloadImageWithURL:[NSURL URLWithString:url] options:0
                                                   progress:^(NSInteger receivedSize, NSInteger expectedSize)
     {
         //å¤„ç†ä¸‹è½½è¿›åº¦
     } completed:^(UIImage *image, NSError *error, SDImageCacheType cacheType, BOOL finished, NSURL *imageURL) {
         
         if (error) {
             NSLog(@"error is %@",error);
         }
         if (image) {
             NSData *data;
             if (UIImagePNGRepresentation(image) == nil) {
                 
                 data = UIImageJPEGRepresentation(image, 1);
                 
             } else {
                 
                 data = UIImagePNGRepresentation(image);
             }
             image = nil;
             NSNumber *adImageId = [_adDic valueForKey:@"advertiseId"];
             NSString *adHtml = [_adDic valueForKey:@"advertiseHtmlUrl"];
             NSString *adName = [_adDic valueForKey:@"advertiseName"];
             
             [[NSUserDefaults standardUserDefaults] setObject:data forKey:[NSString stringWithFormat:@"%@.png",adImageId]];
             [[NSUserDefaults standardUserDefaults] setValue:adHtml forKey:[NSString stringWithFormat:@"%@.html",adImageId]];
             [[NSUserDefaults standardUserDefaults] setValue:adName forKey:[NSString stringWithFormat:@"image_%@",adImageId]];
             [[NSUserDefaults standardUserDefaults] setValue:adImageId forKey:@"advertiseId"];
             [[NSUserDefaults standardUserDefaults] synchronize];
             //å›¾ç‰‡ä¸‹è½½å®Œæˆ  åœ¨è¿™é‡Œè¿›è¡Œç›¸å…³æ“ä½œï¼Œå¦‚åŠ åˆ°æ•°ç»„é‡Œ æˆ–è€…æ˜¾ç¤ºåœ¨imageViewä¸Š
             //                 [[SDImageCache sharedImageCache] storeImage:image forKey:@"anUrlString" toDisk:YES];
             
             //    ä¸‹æ–¹æ˜¯ç”¨SDWebimageåŠ è½½åˆšåˆšç¼“å­˜çš„å›¾ç‰‡
             //             [imageView setImageWithURL:[NSURL URLWithString:@"anUrlString"]];
             
         }
     }];
    
    //    }
}
//
- (void)setNetWork{
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(getUrl) name:WIFI_START object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(getUrl) name:WWAN_START object:nil];
    
    [ExpressRequest StartNetReachablityListen];
}

- (void)setupBugly {
    // Get the default config
    BuglyConfig * config = [[BuglyConfig alloc] init];
    
    // Open the debug mode to print the sdk log message.
    // Default value is NO, please DISABLE it in your RELEASE version.
#if DEBUG
    config.debugMode = YES;
#endif
    
    // Open the customized log record and report, BuglyLogLevelWarn will report Warn, Error log message.
    // Default value is BuglyLogLevelSilent that means DISABLE it.
    // You could change the value according to you need.
    config.reportLogLevel = BuglyLogLevelWarn;
    
    // Open the STUCK scene data in MAIN thread record and report.
    // Default value is NO
    config.blockMonitorEnable = YES;
    
    // Set the STUCK THRESHOLD time, when STUCK time > THRESHOLD it will record an event and report data when the app launched next time.
    // Default value is 3.5 second.
    config.blockMonitorTimeout = 1.5;
    
    // Set the app channel to deployment
    config.channel = @"Bugly";
    
    // NOTE:Required
    // Start the Bugly sdk with APP_ID and your config
    [Bugly startWithAppId:BUGLY_APP_ID config:config];
    
    // Set the customizd tag thats config in your APP registerd on the  bugly.qq.com
    [Bugly setTag:1799];
    
    [Bugly setUserIdentifier:[NSString stringWithFormat:@"User: %@", [NSProcessInfo processInfo].hostName]];
    
    [Bugly setUserValue:[NSProcessInfo processInfo].processName forKey:@"App"];
    
    // NOTE: This is only TEST code for BuglyLog , please UNCOMMENT it in your code.
    //    [self performSelectorInBackground:@selector(testLogOnBackground) withObject:nil];
}

/**
 *    @brief TEST method for BuglyLog
 */
- (void)testLogOnBackground {
    int cnt = 0;
    while (1) {
        cnt++;
        
        switch (cnt % 5) {
            case 0:
                BLYLogError(@"Test Log Print %d", cnt);
                break;
            case 4:
                BLYLogWarn(@"Test Log Print %d", cnt);
                break;
            case 3:
                BLYLogInfo(@"Test Log Print %d", cnt);
                BLYLogv(BuglyLogLevelWarn, @"BLLogv: Test", NULL);
                break;
            case 2:
                BLYLogDebug(@"Test Log Print %d", cnt);
                BLYLog(BuglyLogLevelError, @"BLLog : %@", @"Test BLLog");
                break;
            case 1:
            default:
                BLYLogVerbose(@"Test Log Print %d", cnt);
                break;
        }
        
        // print log interval 1 sec.
        sleep(1);
    }
}


// æœ¬åœ°é€šçŸ¥å›è°ƒ
-(void)application:(UIApplication *)application didReceiveLocalNotification:(UILocalNotification *)notification
{
    [[UIApplication sharedApplication] cancelAllLocalNotifications];
    // æ›´æ–°æ˜¾ç¤ºçš„å¾½ç« ä¸ªæ•°
    NSInteger badge = [UIApplication sharedApplication].applicationIconBadgeNumber;
    badge--;
    badge = badge >= 0 ? badge : 0;
    [UIApplication sharedApplication].applicationIconBadgeNumber = badge;
    // è¿™é‡ŒçœŸå®éœ€è¦å¤„ç†äº¤äº’çš„åœ°æ–¹
    // è·å–é€šçŸ¥æ‰€å¸¦çš„æ•°æ®
    //    æœ¬åœ°é€šçŸ¥(å‰å°)
    
    BOOL ifNeedShowAlert = YES;
    if ([(UINavigationController *)[Utils getCurrentVC].childViewControllers.lastObject isKindOfClass:[ChatViewController class]]) {
        ifNeedShowAlert = NO;
    }
    
    NSString *notMess = [notification.userInfo objectForKey:@"from"];
    /*
     for (UIWindow *window in [UIApplication sharedApplication].windows) {
     if (window.windowLevel == UIWindowLevelAlert) {
     //æœ‰å¼¹çª—å°±ä¸å†å¼¹äº†
     ifNeedShowAlert = NO;
     }
     }
     
     if (ifNeedShowAlert) {
     NSString *notMess = [notification.userInfo objectForKey:@"from"];
     [PXAlertView showAlertWithTitle:nil message:[NSString stringWithFormat:@"æ¥è‡ª%@çš„æ¶ˆæ¯",notMess] completion:^(BOOL cancelled, NSInteger buttonIndex) {
     if (cancelled) {
     NSLog(@"è¿›å…¥èŠå¤©");
     ChatViewController *chaVC=[[ChatViewController alloc]initWithConversationChatter:notMess conversationType:eConversationTypeChat];
     chaVC.title= [NSString stringWithFormat:@"%@",notMess];
     [(UINavigationController *)[Utils getCurrentVC] pushViewController:chaVC animated:YES];
     }
     }];
     }
     */
    
    //    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"" message:[NSString stringWithFormat:@"æ¥è‡ª%@çš„æ¶ˆæ¯",notMess] preferredStyle:UIAlertControllerStyleAlert];
    //
    //    UIAlertAction *sureAction = [UIAlertAction actionWithTitle:@"è¿›å…¥èŠå¤©" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
    //        if ([(UINavigationController *)[Utils getCurrentVC].childViewControllers.lastObject isKindOfClass:[ChatViewController class]]) {
    //            return ;
    //        }
    //        ChatViewController *chaVC=[[ChatViewController alloc]initWithConversationChatter:notMess conversationType:eConversationTypeChat];
    //        chaVC.title= [NSString stringWithFormat:@"%@",notMess];
    //        [(UINavigationController *)[Utils getCurrentVC] pushViewController:chaVC animated:YES];
    //    }];
    //    [alert addAction:sureAction];
    
    //    if (ifNeedShowAlert) {
    //        [[Utils getCurrentVC] presentViewController:alert animated:YES completion:nil];
    //
    //    }
    if (ifNeedShowAlert) {
        [JKNotifier showNotifer:[NSString stringWithFormat:@"æ¥è‡ª%@çš„æ¶ˆæ¯",notMess]  name:@"æˆ‘è¦" icon:[UIImage imageNamed:@"icon"] dismissAfter:100.0];
        
        [JKNotifier handleClickAction:^(NSString *name, NSString *detail, JKNotifier *notifier) {
            if ([(UINavigationController *)[Utils getCurrentVC].childViewControllers.lastObject isKindOfClass:[ChatViewController class]]) {
                return ;
            }
            [JKNotifier dismiss];
            ChatViewController *chaVC=[[ChatViewController alloc]initWithConversationChatter:notMess conversationType:eConversationTypeChat];
            chaVC.title= [NSString stringWithFormat:@"%@",notMess];
            [(UINavigationController *)[Utils getCurrentVC] pushViewController:chaVC animated:YES];
        }];
    }
    
    // åœ¨ä¸éœ€è¦å†æ¨é€æ—¶ï¼Œå¯ä»¥å–æ¶ˆæ¨é€
    //    [UtilNotif cancelLocalNotificationWithKey:@"key"];
    
}

- (void)EaseMobLogin{
    [[EaseMob sharedInstance].chatManager asyncRegisterNewAccount:[UserManager getDefaultUser].userId password:@"201218" withCompletion:^(NSString *username, NSString *password, EMError *error) {
        NSLog(@"%@",error);
        if (!error) {
            NSLog(@"æ³¨å†ŒæˆåŠŸ");
            [[EaseMob sharedInstance].chatManager asyncLoginWithUsername:[UserManager getDefaultUser].userId password:@"201218" completion:^(NSDictionary *loginInfo, EMError *error) {
                NSLog(@"%@",error);
                if (!error && loginInfo) {
                    NSLog(@"ç¯ä¿¡ç™»å½•æˆåŠŸ");
                    NSLog(@"%@",loginInfo);
                    [[EaseMob sharedInstance].chatManager loadDataFromDatabase];
                }
            } onQueue:nil];
        }else if (error.errorCode == EMErrorServerDuplicatedAccount){
            //è´¦å·å·²å­˜åœ¨
            [[EaseMob sharedInstance].chatManager asyncLoginWithUsername:[UserManager getDefaultUser].userId password:@"201218" completion:^(NSDictionary *loginInfo, EMError *error) {
                NSLog(@"%@",error);
                if (!error && loginInfo) {
                    NSLog(@"ç¯ä¿¡ç™»å½•æˆåŠŸ");
                    NSLog(@"%@",loginInfo);
                    [[EaseMob sharedInstance].chatManager loadDataFromDatabase];
                }
            } onQueue:nil];
        }
    } onQueue:nil];
}

- (void)didReceiveMessage:(EMMessage *)message
{
    NSDictionary *dic = @{@"from":message.from,
                          @"body":message.messageId};
    [UtilNotif sendMess:0 body:@"æ‚¨æœ‰æ–°çš„æ¶ˆæ¯" noticeDic:dic];
}

- (void)updateUser{
    if ([UserManager getDefaultUser].userId) {
        [RequestManager getuserinfoWithuserId:[UserManager getDefaultUser].userId success:^(NSString *reslut) {
            NSLog(@"æ›´æ–°ä¿¡æ¯æˆåŠŸ");
        } Failed:^(NSString *error) {
            NSLog(@"æ›´æ–°å¤±è´¥");
        }];
    }
}

#pragma mark-- updateLocation

- (void)uploadLocation:(CLLocationCoordinate2D )loc{
    NSDictionary *dic = @{k_USER_ID:[UserManager getDefaultUser].userId,
                          k_USER_TYPE:[NSNumber numberWithInt:[UserManager getDefaultUser].userType],
                          USER_LOCATION_LAT:[NSNumber numberWithDouble:loc.latitude],
                          USER_LOCATION_LON:[NSNumber numberWithDouble:loc.longitude]};
    [ExpressRequest sendWithParameters:dic MethodStr:API_LOCAT_UPLOAD reqType:k_POST success:^(id object) {
        NSLog(@"åå°ä¸Šä¼ ä½ç½®æˆåŠŸ");
    } failed:^(NSString *error) {
        NSLog(@"åå°ä¸Šä¼ ä½ç½®å¤±è´¥:%@",error);
    }];
}

#pragma mark -  å®šä½ä»£ç†æ–¹æ³•
- (void)locationManager:(CLLocationManager *)manager didUpdateLocations:(NSArray<CLLocation *> *)locations
{
    CLLocation *loc = [locations objectAtIndex:0];
    
    NSLog(@"è°·æ­Œåœ°çƒç»çº¬åº¦  %f  %f ",loc.coordinate.latitude,loc.coordinate.longitude);
    
    CLLocationCoordinate2D coor = loc.coordinate;//åŸå§‹åæ ‡
    //è½¬æ¢GPSåæ ‡è‡³ç™¾åº¦åæ ‡(åŠ å¯†åçš„åæ ‡)
    NSDictionary* testdic = BMKConvertBaiduCoorFrom(coor,BMK_COORDTYPE_GPS);
    
    //è§£å¯†åŠ å¯†åçš„åæ ‡å­—å…¸
    CLLocationCoordinate2D baiduCoor = BMKCoorDictionaryDecode(testdic);//è½¬æ¢åçš„ç™¾åº¦åæ ‡
    [self uploadLocation:baiduCoor];
}

- (void)onGetPermissionState:(int)iError{
    NSLog(@"%d",iError);
}
- (void)onGetNetworkState:(int)iError{
    NSLog(@"%d",iError);
}


@end
